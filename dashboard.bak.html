<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Dashboard de Operaciones</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
  <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;700;900&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#1173d4",
            "background-light": "#f6f7f8",
            "background-dark": "#101922",
            "text-light": "#101922",
            "text-dark": "#f6f7f8",
            "text-muted-light": "#6b7280",
            "text-muted-dark": "#9ca3af",
            "card-light": "#ffffff",
            "card-dark": "#1a2530",
            "border-light": "#e5e7eb",
            "border-dark": "#374151"
          },
          fontFamily: { "display": ["Work Sans", "sans-serif"] },
          borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
        },
      },
    }
  </script>
  <style>
    .material-symbols-outlined{font-variation-settings:'FILL'0,'wght'400,'GRAD'0,'opsz'24}
    body{min-height:max(884px,100dvh)}
  </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display">
  <div class="flex flex-col min-h-screen">
    <!-- Header -->
    <header class="sticky top-0 z-10 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm border-b border-border-light dark:border-border-dark">
      <div class="flex items-center justify-between p-4">
        <button onclick="window.location.href='inicioSesion.html'" class="p-2 text-text-light dark:text-text-dark">Cerrar Sesion</button>
        <h1 class="text-xl font-bold text-text-light dark:text-text-dark">Dashboard</h1>
        <button class="p-2 text-text-light dark:text-text-dark" title="Notificaciones">
          <span class="material-symbols-outlined">notifications</span>
        </button>
      </div>
    </header>

    <!-- Main -->
    <main class="flex-1 p-4 space-y-6">
      <!-- Solicitudes pendientes -->
      <section class="space-y-4">
        <h2 class="text-lg font-bold text-text-light dark:text-text-dark">Solicitudes pendientes</h2>
        <div id="pendingReqList" class="space-y-3"></div>
      </section>
      <!-- Incidencias de Conductores -->
      <section class="space-y-4">
        <h2 class="text-lg font-bold text-text-light dark:text-text-dark">Incidencias de Conductores</h2>
        <div id="incidList" class="space-y-3"></div>
      </section>
      <!-- Alertas -->
      <section class="space-y-4">
        <h2 class="text-lg font-bold text-text-light dark:text-text-dark">Alertas de Mantenimiento</h2>
        <div id="alertsList" class="space-y-4"></div>
      </section>

      <!-- KPIs -->
      <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="flex flex-col gap-2 p-4 rounded-lg bg-card-light dark:bg-card-dark shadow">
          <p class="text-sm font-medium text-text-muted-light dark:text-text-muted-dark">Autobuses Activos</p>
          <p id="kpiBuses" class="text-3xl font-bold text-primary">0</p>
        </div>
        <div class="flex flex-col gap-2 p-4 rounded-lg bg-card-light dark:bg-card-dark shadow">
          <p class="text-sm font-medium text-text-muted-light dark:text-text-muted-dark">Rutas en Curso (mas)</p>
          <p id="kpiRutas" class="text-3xl font-bold text-primary">0</p>
        </div>
      </section>

      <!-- Prximos viajes (mos) -->
      <section class="space-y-4">
        <h2 class="text-lg font-bold text-text-light dark:text-text-dark">Proximos Viajes</h2>
        <div id="nextTripsList" class="p-4 space-y-4 bg-card-light dark:bg-card-dark rounded-lg shadow"></div>
      </section>
    </main>

    <!-- Footer nav -->
    <footer class="sticky bottom-0 z-10 border-t bg-background-light dark:bg-background-dark border-border-light dark:border-border-dark">
      <nav class="flex justify-around p-2">
        <a class="flex flex-col items-center justify-center w-full gap-1 p-2 rounded-lg text-primary" href="dashboard.html">
          <span class="material-symbols-outlined">home</span><span class="text-xs font-medium">Inicio</span>
        </a>
        <a class="flex flex-col items-center justify-center w-full gap-1 p-2 rounded-lg text-text-muted-light dark:text-text-muted-dark hover:text-primary dark:hover:text-primary transition-colors" href="gestiondeRutas.html">
          <span class="material-symbols-outlined">map</span><span class="text-xs font-medium">Rutas</span>
        </a>
        <a class="flex flex-col items-center justify-center w-full gap-1 p-2 rounded-lg text-text-muted-light dark:text-text-muted-dark hover:text-primary dark:hover:text-primary transition-colors" href="gestiondeViajesDiscrecionales.html">
          <span class="material-symbols-outlined">commute</span><span class="text-xs font-medium">Viajes</span>
        </a>
        <a class="flex flex-col items-center justify-center w-full gap-1 p-2 rounded-lg text-text-muted-light dark:text-text-muted-dark hover:text-primary dark:hover:text-primary transition-colors" href="gestiondeFlota.html">
          <span class="material-symbols-outlined">directions_bus</span><span class="text-xs font-medium">Flota</span>
        </a>
        <a class="flex flex-col items-center justify-center w-full gap-1 p-2 rounded-lg text-text-muted-light dark:text-text-muted-dark hover:text-primary dark:hover:text-primary transition-colors" href="gestiondeEmpleados.html">
          <span class="material-symbols-outlined">group</span><span class="text-xs font-medium">Empleados</span>
        </a>
      </nav>
    </footer>
  </div>

  <!-- ======= LGICA ======= -->
  <script>
  /************** Identidad de usuario (persistente en localStorage) **************/
  const LS_USER = 'current_user_id';
  function getCurrentUserId(){
    let id = localStorage.getItem(LS_USER);
    if (!id) {
      id = 'user-' + (crypto?.randomUUID?.() || Math.random().toString(36).slice(2));
      localStorage.setItem(LS_USER, id);
    }
    return id;
  }
  const CURRENT_USER_ID = getCurrentUserId();

  /************** Claves de almacenamiento **************/
  const LS_BUSES = 'flota_autobuses_v1';
  const LS_TRIPS = 'viajes_discrecionales_v1';

  /************** Utilidades de fecha **************/
  const daysUntil = (target, from = new Date()) => {
    const t = new Date(target.getFullYear(), target.getMonth(), target.getDate());
    const f = new Date(from.getFullYear(), from.getMonth(), from.getDate());
    return Math.round((t - f) / (1000*60*60*24));
  };

  /************** Carga de datos **************/
  const loadBuses = () => { try { return JSON.parse(localStorage.getItem(LS_BUSES) || '[]'); } catch { return []; } };
  const loadTrips = () => { try { return JSON.parse(localStorage.getItem(LS_TRIPS) || '[]'); } catch { return []; } };
  const saveTrips = (trips) => localStorage.setItem(LS_TRIPS, JSON.stringify(trips));
  const LS_NOTIFS = 'notificaciones_v1';
  const LS_INCID = 'incidencias_conductores_v1';
  const CHAT_KEY = 'chatMensajeriaDiscrecionales';

  // Si la flota est vaca, sembramos algunos buses para que el jefe/admin pueda aceptar
  function ensureSeedBuses(){
    try{
      const cur = loadBuses();
      if (Array.isArray(cur) && cur.length) return;
      const seed = [
        { id:'bus-1234', plate:'1234 ABC', model:'Volvo 9700', km:100000, seats:55, img:'', maintenance:[] },
        { id:'bus-5678', plate:'5678 DEF', model:'Mercedes Citaro', km:180000, seats:59, img:'', maintenance:[] },
        { id:'bus-9012', plate:'9012 GHI', model:'Scania Irizar i6', km:140000, seats:63, img:'', maintenance:[] }
      ];
      localStorage.setItem(LS_BUSES, JSON.stringify(seed));
    }catch{}
  }
  function pushNotification(toUserId, title, body){
    try{
      const list = JSON.parse(localStorage.getItem(LS_NOTIFS)||'[]');
      list.push({ id: 'ntf_'+Date.now(), to: toUserId, title, body, read:false, createdAt: new Date().toISOString() });
      localStorage.setItem(LS_NOTIFS, JSON.stringify(list));
      // Disparo para listeners inter-pestaa
      localStorage.setItem('notif_ping', String(Date.now()));
    }catch{}
  }

  function pushChatFromAdmin(text){
    try {
      const list = JSON.parse(localStorage.getItem(CHAT_KEY) || '[]');
      list.push({ role: 'agent', text, time: new Date().toLocaleString('es-ES', { dateStyle:'short', timeStyle:'short' }), ts: Date.now() });
      localStorage.setItem(CHAT_KEY, JSON.stringify(list));
      localStorage.setItem('chat_ping', String(Date.now()));
    } catch {}
  }

  /************** Incidencias **************/
  const loadIncidents = () => { try { return JSON.parse(localStorage.getItem(LS_INCID) || '[]'); } catch { return []; } };
  const saveIncidents = (l) => localStorage.setItem(LS_INCID, JSON.stringify(l));

  function resolveIncident(id){
    const list = loadIncidents();
    const idx = list.findIndex(i => i.id === id);
    if (idx < 0) return;
    list[idx] = { ...list[idx], status: 'resuelta', resolvedAt: new Date().toISOString(), resolvedBy: CURRENT_USER_ID };
    saveIncidents(list);
    renderIncidents();
  }

  function renderIncidents(){
    const box = document.getElementById('incidList'); if (!box) return;
    box.innerHTML = '';
    const list = loadIncidents().slice().sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
    if (!list.length){
      box.innerHTML = `<div class="p-4 rounded-lg bg-card-light dark:bg-card-dark border border-border-light dark:border-border-dark">
        <p class="text-sm text-text-muted-light dark:text-text-muted-dark">No hay incidencias reportadas.</p>
      </div>`; return;
    }
    list.forEach(inc => {
      const when = new Date(inc.createdAt||Date.now());
      const card = document.createElement('div');
      card.className = 'p-4 rounded-lg bg-card-light dark:bg-card-dark border border-border-light dark:border-border-dark';
      const statusColor = (inc.status === 'resuelta') ? 'text-green-600' : 'text-amber-600';
      const statusLabel = (inc.status === 'resuelta') ? 'Resuelta' : 'Abierta';
      card.innerHTML = `
        <div class="flex items-start gap-4">
          <div class="rounded-lg bg-primary/10 dark:bg-primary/20 p-2 text-primary">
            <span class="material-symbols-outlined">report</span>
          </div>
          <div class="flex-1">
            <p class="font-bold text-text-light dark:text-text-dark">${(inc.type||'Incidencia')}  <span class="text-sm text-text-muted-light dark:text-text-muted-dark">${when.toLocaleString('es-ES')}</span></p>
            <p class="text-sm text-text-muted-light dark:text-text-muted-dark">Conductor: ${inc.driverName || inc.driverId || ''}</p>
            ${inc.description ? `<p class="text-sm text-text-light dark:text-text-dark mt-1">${inc.description}</p>` : ''}
          </div>
          <div class="flex flex-col items-end gap-2">
            <span class="text-xs font-bold ${statusColor}">${statusLabel}</span>
            ${inc.status !== 'resuelta' ? `<button class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-bold" onclick="resolveIncident('${inc.id}')">Marcar resuelta</button>` : ''}
          </div>
        </div>`;
      box.appendChild(card);
    });
  }

  /************** Alertas SOLO de mis mantenimientos **************/
  // Ventanas de aviso (en das)
  const ALERT_THRESH = { itv: 30, oil: 15, rev: 30 }; // ajusta si quieres 60/60/60

  function computeAlertsMyMaintenance(buses) {
    const now = new Date();
    const alerts = [];

    buses.forEach(b => {
      const mine = (b.maintenance || []).filter(m => m.createdBy === CURRENT_USER_ID);
      if (mine.length === 0) return;

      const lastByType = (type) => {
        const list = mine.filter(m => (m.type||'').toLowerCase() === type.toLowerCase());
        if (!list.length) return null;
        return list.sort((a,b) => (b.date||'').localeCompare(a.date||''))[0];
      };

      const pushAlert = (title, daysLeft, icon) => {
        const severity = (daysLeft < 0) ? 'red' : (daysLeft <= 7 ? 'red' : 'amber');
        alerts.push({
          severity, icon,
          title: `${title} (${daysLeft} ${Math.abs(daysLeft)===1?'da':'das'})`,
          subtitle: `${b.model} (Mat. ${b.plate})`,
          href: 'gestiondeMantenimiento3.html'
        });
      };

      // ITV: ltima + 12 meses
      const lastItv = lastByType('ITV');
      if (lastItv?.date) {
        const next = new Date(lastItv.date + 'T00:00:00');
        next.setMonth(next.getMonth() + 12);
        const d = daysUntil(next, now);
        if (d <= ALERT_THRESH.itv) pushAlert('ITV prxima', d, 'build');
      }

      // Aceite: ltima + 6 meses
      const lastOil = lastByType('Aceite');
      if (lastOil?.date) {
        const next = new Date(lastOil.date + 'T00:00:00');
        next.setMonth(next.getMonth() + 6);
        const d = daysUntil(next, now);
        if (d <= ALERT_THRESH.oil) pushAlert('Cambio de aceite', d, 'oil_barrel');
      }

      // Revisin: ltima + 12 meses
      const lastRev = lastByType('Revisin');
      if (lastRev?.date) {
        const next = new Date(lastRev.date + 'T00:00:00');
        next.setMonth(next.getMonth() + 12);
        const d = daysUntil(next, now);
        if (d <= ALERT_THRESH.rev) pushAlert('Revisin anual', d, 'engineering');
      }
    });

    // Orden: rojas antes y por das restantes
    const sevRank = { red: 0, amber: 1 };
    alerts.sort((a,b) => {
      const s = sevRank[a.severity] - sevRank[b.severity];
      if (s) return s;
      const ad = parseInt((a.title.match(/(-?\d+)\s*d[i]a/)||[])[1]||'999',10);
      const bd = parseInt((b.title.match(/(-?\d+)\s*d[i]a/)||[])[1]||'999',10);
      return ad - bd;
    });
    return alerts;
  }

  function renderAlerts(list) {
    const container = document.getElementById('alertsList');
    container.innerHTML = '';
    if (!list || !list.length) {
      container.innerHTML = `
        <div class="p-4 rounded-lg bg-card-light dark:bg-card-dark border border-border-light dark:border-border-dark">
          <p class="text-sm text-text-muted-light dark:text-text-muted-dark">No hay alertas de mantenimiento de tus registros.</p>
        </div>`;
      return;
    }
    list.forEach(a => {
      const isRed = a.severity === 'red';
      const bg   = isRed ? 'bg-red-500/10 dark:bg-red-500/20 hover:bg-red-500/20 dark:hover:bg-red-500/30'
                         : 'bg-amber-500/10 dark:bg-amber-500/20 hover:bg-amber-500/20 dark:hover:bg-amber-500/30';
      const text = isRed ? 'text-red-700 dark:text-red-400' : 'text-amber-700 dark:text-amber-400';
      const iconWrap = isRed ? 'text-red-500 bg-red-500/20' : 'text-amber-500 bg-amber-500/20';

      const card = document.createElement('a');
      card.className = `block p-4 rounded-lg shadow transition-colors ${bg}`;
      card.href = a.href;
      card.innerHTML = `
        <div class="flex items-center gap-4">
          <div class="p-3 ${iconWrap} rounded-full"><span class="material-symbols-outlined">${a.icon}</span></div>
          <div class="flex-1">
            <p class="font-bold ${text}">${a.title}</p>
            <p class="text-sm ${isRed ? 'text-red-600 dark:text-red-300' : 'text-amber-600 dark:text-amber-300'}">${a.subtitle}</p>
          </div>
          <span class="material-symbols-outlined text-text-muted-light dark:text-text-muted-dark">chevron_right</span>
        </div>`;
      container.appendChild(card);
    });
  }

  /************** Solicitudes pendientes (oficina/admin) **************/
  function intervalsOverlap(aStart, aEnd, bStart, bEnd){ return (aStart < bEnd) && (bStart < aEnd); }

  function ensureSeedEmployees(){
    const LS_EMPL = 'empleados_v1';
    try {
      const emps = JSON.parse(localStorage.getItem(LS_EMPL)||'[]');
      if (Array.isArray(emps) && emps.length) return;
      localStorage.setItem(LS_EMPL, JSON.stringify([
        { id:'drv-1', name:'Juan Prez', role:'driver' },
        { id:'drv-2', name:'Mara Lpez', role:'driver' }
      ]));
    } catch {}
  }
  function findAvailableDriver(start, end, excludeId){
    const emps = (()=>{ try { return JSON.parse(localStorage.getItem('empleados_v1')||'[]'); } catch { return []; } })()
      .filter(e => (e.role||'').toLowerCase()==='driver' && e.id!==excludeId);
    const trips = loadTrips();
    for (const d of emps){
      const busy = trips.some(t => t.driverId===d.id && intervalsOverlap(new Date(t.start), new Date(t.end), start, end));
      if (!busy) return d;
    }
    return null;
  }
  function findAvailableBus(capacityNeeded, start, end){
    const buses = loadBuses();
    const trips = loadTrips();
    const candidates = buses.filter(b => (b.seats||0) >= capacityNeeded)
                            .sort((a,b)=>(a.seats||999)-(b.seats||999));
    for (const bus of candidates){
      const used = trips.some(t => t.busPlate===bus.plate && intervalsOverlap(new Date(t.start), new Date(t.end), start, end));
      if (!used) return bus;
    }
    return null;
  }

  function acceptRequest(id){
    ensureSeedEmployees();
    ensureSeedBuses();
    const trips = loadTrips();
    const idx = trips.findIndex(t => t.id===id && t.state==='pendiente');
    if (idx<0) { alert('Solicitud no encontrada'); return; }
    const t = trips[idx];
    const start = new Date(t.start), end = new Date(t.end);
    const bus = findAvailableBus(t.plazas||0, start, end);
    if (!bus) { alert('No hay autobs disponible para ese horario.'); return; }
    const driver = findAvailableDriver(start, end);
    if (!driver) { alert('No hay conductor disponible para ese horario.'); return; }

    let driver2 = null;
    if (t.extras?.secondDriver) {
      driver2 = findAvailableDriver(start, end, driver.id);
    }

    trips[idx] = {
      ...t,
      busPlate: bus.plate, busModel: bus.model, busSeats: bus.seats,
      driverId: driver.id, driverName: driver.name,
      driver2Id: driver2?.id||null, driver2Name: driver2?.name||null,
      state: 'confirmado',
      assignedBy: CURRENT_USER_ID,
      assignedAt: new Date().toISOString()
    };
    saveTrips(trips);
    renderAll();
    alert('Solicitud aceptada y asignada.');
    // Mensaje al chat del cliente
    try { const asg = trips[idx]; const msg = `Tu solicitud ${t.origen}  ${t.destino} ha sido CONFIRMADA.`; pushChatFromAdmin(msg + (asg?.busPlate ? ` Bus asignado: ${asg.busPlate}.` : '')); } catch {}
    // Notificar al cliente creador
    try{
      pushNotification(t.createdBy, 'Viaje confirmado', `${t.origen}  ${t.destino} ha sido confirmado.`);
    }catch{}
  }
  function rejectRequest(id){
    const trips = loadTrips();
    const idx = trips.findIndex(t => t.id===id && t.state==='pendiente');
    if (idx<0) { alert('Solicitud no encontrada'); return; }
    const reason = prompt('Motivo del rechazo:');
    if (reason === null) return; // cancelado
    trips[idx] = { ...trips[idx], state: 'rechazado', rejectedBy: CURRENT_USER_ID, rejectedAt: new Date().toISOString(), rejectReason: (reason||'No especificado') };
    saveTrips(trips);
    renderAll();
    try{
      const t = trips[idx];
      const msg = `Tu solicitud ${t.origen}  ${t.destino} ha sido RECHAZADA. Motivo: ${(t.rejectReason||'No especificado')}`;
      pushNotification(t.createdBy, 'Viaje rechazado', msg);
      pushChatFromAdmin(msg);
    }catch{}
  }

  function renderPending(){
    const box = document.getElementById('pendingReqList');
    if (!box) return;
    box.innerHTML = '';
    const list = (loadTrips()||[]).filter(t => t.state==='pendiente');
    if (!list.length){
      box.innerHTML = `<div class="p-4 rounded-lg bg-card-light dark:bg-card-dark border border-border-light dark:border-border-dark">
        <p class="text-sm text-text-muted-light dark:text-text-muted-dark">No hay solicitudes pendientes.</p>
      </div>`;
      return;
    }
    list.sort((a,b)=> new Date(a.start)-new Date(b.start));
    list.forEach(t => {
      const when = new Date(t.start);
      const card = document.createElement('div');
      card.className = 'p-4 rounded-lg bg-card-light dark:bg-card-dark border border-border-light dark:border-border-dark flex items-center gap-4';
      card.innerHTML = `
        <div class="flex-1">
          <p class="font-bold text-text-light dark:text-text-dark">${t.origen}  ${t.destino}</p>
          <p class="text-sm text-text-muted-light dark:text-text-muted-dark">${when.toLocaleString('es-ES',{weekday:'short', day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit'})} " ${t.plazas} plazas</p>
        </div>
        <div class="flex gap-2">
          <button class="px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-bold" onclick="acceptRequest('${t.id}')">Aceptar</button>
          <button class="px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-bold" onclick="rejectRequest('${t.id}')">Rechazar</button>
        </div>`;
      box.appendChild(card);
    });
  }

  /************** Prximos viajes (confirmados, global) **************/
  function renderMyNextTrips() {
    const box = document.getElementById('nextTripsList');
    box.innerHTML = '';

    const now = new Date();
    const trips = (loadTrips() || [])
      .filter(t => (t.state||'') === 'confirmado')
      .filter(t => new Date(t.start) >= now)
      .sort((a,b) => new Date(a.start) - new Date(b.start))
      .slice(0, 6);

    if (!trips.length) {
      box.innerHTML = `
        <div class="p-4 rounded-lg bg-card-light dark:bg-card-dark border border-border-light dark:border-border-dark">
          <p class="text-sm text-text-muted-light dark:text-text-muted-dark">No hay prximos viajes confirmados.</p>
        </div>`;
      return;
    }

    trips.forEach((t, i) => {
      const when = new Date(t.start);
      const dateStr = when.toLocaleString('es-ES', { weekday:'long', day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit' });
      const card = document.createElement('div');
      card.className = 'flex items-center gap-4';
      card.innerHTML = `
        <div class="flex-1">
          <p class="text-xs text-text-muted-light dark:text-text-muted-dark capitalize">${dateStr}</p>
          <p class="font-bold text-text-light dark:text-text-dark">${t.origen}  ${t.destino}</p>
          <p class="text-sm text-text-muted-light dark:text-text-muted-dark">Bus ${t.busPlate || ''} " ${t.plazas} plazas</p>
        </div>
        <div class="w-20 h-20 bg-center bg-cover rounded-lg"
             style='background-image:url("https://images.unsplash.com/photo-1494515744325-68b21fe966ff?q=80&w=300&auto=format&fit=crop");'></div>`;
      box.appendChild(card);
      if (i !== trips.length-1) {
        const hr = document.createElement('hr');
        hr.className = 'border-border-light dark:border-border-dark my-2';
        box.appendChild(hr);
      }
    });
  }

  /************** KPIs **************/
  function renderKpis(buses) {
    // Buses activos = todos los registrados
    const elBuses = document.getElementById('kpiBuses');
    if (elBuses) elBuses.textContent = buses.length || 0;

    // Rutas en curso = trips confirmados con now  [start, end]
    const now = new Date();
    const trips = loadTrips() || [];
    const inProgressMine = trips.filter(t =>
      (t.state||'')==='confirmado' && new Date(t.start) <= now && now <= new Date(t.end)
    ).length;
    const elRutas = document.getElementById('kpiRutas');
    if (elRutas) elRutas.textContent = inProgressMine;
  }

  /************** Render global **************/
  function renderAll() {
    const buses = loadBuses();
    renderKpis(buses);
    const alerts = computeAlertsMyMaintenance(buses);
    renderAlerts(alerts);
    renderPending();
    renderIncidents();
    renderMyNextTrips();
  }

  // Boot
  window.addEventListener('DOMContentLoaded', renderAll);
  // Si cambian flota o viajes desde otras vistas/pestaas, refrescar
  window.addEventListener('storage', (e) => {
    if ([LS_BUSES, LS_TRIPS, LS_INCID, 'incidencias_ping'].includes(e.key)) renderAll();
  });
  </script>
  <script>
    (function guardAndLogout(){
      const role = localStorage.getItem('role');
      if (role === 'conductor') { window.location.href = 'aplicacionConductor.html'; return; }
      if (role === 'cliente') { window.location.href = 'gestiondeRutas.html'; return; }

      const hdr = document.querySelector('header');
      const btns = hdr ? hdr.querySelectorAll('button') : [];
      if (btns && btns.length) {
        btns[0].onclick = function(){
          localStorage.removeItem('role');
          localStorage.removeItem('username');
          window.location.href = 'inicioSesion.html';
        };
      }

      // Botn Reset Demo (admin)
      try {
        const row = hdr?.querySelector('.flex.items-center.justify-between');
        if (row) {
          const reset = document.createElement('button');
          reset.className = 'p-2 text-text-light dark:text-text-dark';
          reset.title = 'Reset demo (borra solicitudes y viajes)';
          reset.textContent = 'Reset';
          reset.onclick = function(){
            if (!confirm('Borrar todas las solicitudes y viajes?')) return;
            localStorage.removeItem('viajes_discrecionales_v1');
            localStorage.removeItem('notificaciones_v1');
            localStorage.removeItem('notif_ping');
            try { renderAll(); } catch {}
            alert('Datos de viajes reseteados.');
          };
          row.appendChild(reset);
        }
      } catch {}
    })();
  </script>
  <script>
    // Rebuild header: left logo, center title, right logout
    document.addEventListener('DOMContentLoaded', function(){
      try{
        const row = document.querySelector('header .flex.items-center.justify-between');
        if (!row) return;
        row.innerHTML = '';
        const left = document.createElement('div'); left.className='flex items-center gap-2';
        const img = document.createElement('img'); img.src='logo.png'; img.alt='Logo'; img.className='h-8 w-8 object-contain'; img.onerror = function(){ this.style.display='none'; };
        left.appendChild(img);
        const title = document.createElement('h1'); title.className='text-xl font-bold text-text-light dark:text-text-dark'; title.textContent='Dashboard';
        const logout = document.createElement('button'); logout.id='btnLogout2'; logout.className='p-2 text-text-light dark:text-text-dark'; logout.textContent='Cerrar sesin';
        logout.onclick = function(){ localStorage.removeItem('role'); localStorage.removeItem('username'); window.location.href='inicioSesion.html'; };
        row.appendChild(left); row.appendChild(title); row.appendChild(logout);
      }catch{}
    });
  </script>
  <script>
    // KPIs reales: recalcula con datos actuales de viajes
    (function fixRealKpis(){
      function loadTripsSafe(){ try { return JSON.parse(localStorage.getItem('viajes_discrecionales_v1')||'[]'); } catch { return []; } }
      function update(){
        const now = new Date();
        const trips = loadTripsSafe().filter(t => (t.state||'')==='confirmado' && new Date(t.start)<=now && now<=new Date(t.end));
        const activeBusSet = new Set(trips.map(t=>t.busPlate).filter(Boolean));
        const elB = document.getElementById('kpiBuses');
        const elR = document.getElementById('kpiRutas');
        if (elB) elB.textContent = activeBusSet.size;
        if (elR) elR.textContent = trips.length;
        // Arregla el ttulo si viene mal codificado
        try { const label = elR && elR.previousElementSibling; if (label && label.tagName==='P') label.textContent = 'Rutas en Curso'; } catch {}
      }
      window.addEventListener('DOMContentLoaded', update);
      window.addEventListener('storage', (e)=>{ if (e.key==='viajes_discrecionales_v1') update(); });
    })();
  </script>
  <script>
    (function enforceRealKpis(){
      function loadTripsSafe(){ try { return JSON.parse(localStorage.getItem('viajes_discrecionales_v1')||'[]'); } catch { return []; } }
      function renderReal(){
        const now=new Date();
        const trips=loadTripsSafe().filter(t=>(t.state||'')==='confirmado' && new Date(t.start)<=now && now<=new Date(t.end));
        const activeBusSet=new Set(trips.map(t=>t.busPlate).filter(Boolean));
        const elB=document.getElementById('kpiBuses');
        const elR=document.getElementById('kpiRutas');
        if(elB) elB.textContent=activeBusSet.size;
        if(elR) elR.textContent=trips.length;
        try{const label=elR && elR.previousElementSibling; if(label && label.tagName==='P') label.textContent='Rutas en Curso';}catch{}
      }
      window.renderKpis = function(){ renderReal(); };
      renderReal();
      window.addEventListener('storage', (e)=>{ if(e.key==='viajes_discrecionales_v1') renderReal(); });
    })();
  </script>
  </body>
</html>

