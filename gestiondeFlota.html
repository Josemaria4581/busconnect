<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>Stitch Design · Flota</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Work+Sans:wght@400;500;700;900"
    onload="this.rel='stylesheet'" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#1173d4",
            "background-light": "#f6f7f8",
            "background-dark": "#101922",
          },
          fontFamily: { "display": ["Work Sans"] },
          borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
        },
      },
    }
  </script>
  <style>
    body {
      min-height: max(884px, 100dvh);
    }

    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 500, 'GRAD' 0, 'opsz' 24
    }
  </style>
  </style>
  <script src="api-sync.js"></script>
</head>

<body class="bg-background-light dark:bg-background-dark font-display">
  <div class="relative flex flex-col min-h-screen w-full">

    <!-- Header -->
    <header class="sticky top-0 z-10 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm">
      <div class="flex items-center p-4">
        <button id="backBtn" class="text-gray-700 dark:text-gray-300 invisible">
          <span class="material-symbols-outlined">arrow_back</span>
        </button>
        <h1 id="title" class="text-lg font-bold text-gray-900 dark:text-white flex-1 text-center">Flota</h1>
        <div class="w-8"></div>
      </div>
    </header>

    <!-- MAIN -->
    <main class="flex-1 overflow-y-auto p-4 space-y-4 pb-24">

      <!-- ======= Vista: Lista Flota ======= -->
      <section id="viewFleet">
        <div class="flex flex-col items-center justify-center gap-4 mb-6">
          <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Nuestra Flota</h2>
          <button id="btnNewBus"
            class="px-6 py-2 rounded-full bg-primary text-white hover:bg-primary/90 text-base font-medium shadow-md inline-flex items-center gap-2 transition-transform hover:scale-105">
            <span class="material-symbols-outlined">add_circle</span> Añadir nuevo autobús
          </button>
        </div>
        <div id="busList" class="bg-white dark:bg-background-dark/50 rounded-xl shadow-sm p-4 flex flex-col gap-4">
          <!-- Se pinta por JS -->
        </div>
      </section>

      <!-- ======= Vista: Detalle Autobús ======= -->
      <section id="viewBus" class="hidden">
        <div class="flex items-center gap-3">
          <div id="busImg" class="w-16 h-16 rounded-lg bg-center bg-no-repeat bg-cover"></div>
          <div>
            <p class="text-base font-bold text-gray-900 dark:text-white" id="busPlate">—</p>
            <p class="text-sm text-gray-600 dark:text-gray-400" id="busModel">—</p>
          </div>
        </div>

        <!-- Edición de datos básicos -->
        <div class="mt-4 bg-white dark:bg-background-dark/50 rounded-xl shadow-sm p-4 space-y-3">
          <h3 class="text-base font-bold text-gray-900 dark:text-white">Datos del autobús</h3>
          <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
            <div>
              <label class="text-sm text-gray-600 dark:text-gray-300">Matrícula</label>
              <input id="inpPlate" type="text" class="mt-1 w-full" />
            </div>
            <div>
              <label class="text-sm text-gray-600 dark:text-gray-300">Modelo</label>
              <input id="inpModel" type="text" class="mt-1 w-full" />
            </div>
            <div>
              <label class="text-sm text-gray-600 dark:text-gray-300">Kilómetros</label>
              <input id="inpKm" type="number" min="0" step="1" class="mt-1 w-full" />
            </div>
            <div>
              <label class="text-sm text-gray-600 dark:text-gray-300">Plazas</label>
              <input id="inpSeats" type="number" min="8" step="1" class="mt-1 w-full" placeholder="p.ej. 55" />
            </div>
            <div>
              <label class="text-sm text-gray-600 dark:text-gray-300">Imagen (URL)</label>
              <input id="inpImg" type="url" class="mt-1 w-full" placeholder="https://..." />
            </div>
          </div>
          <div class="flex gap-2 pt-2">
            <button id="btnSaveStay"
              class="px-4 py-2 rounded-lg bg-primary text-white hover:bg-primary/90 transition">Guardar y seguir
              aquí</button>
            <button id="btnSaveBack"
              class="px-4 py-2 rounded-lg bg-white text-primary border border-primary hover:bg-primary/10 transition">Guardar
              y volver</button>
            <button id="btnDeleteBus"
              class="ml-auto px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 transition">Eliminar
              bus</button>
          </div>
        </div>

        <!-- Alta de mantenimiento -->
        <div class="mt-4 bg-white dark:bg-background-dark/50 rounded-xl shadow-sm p-4 space-y-3">
          <h3 class="text-base font-bold text-gray-900 dark:text-white">Mantenimiento (manual)</h3>
          <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
            <div>
              <label class="text-sm text-gray-600 dark:text-gray-300">Fecha</label>
              <input id="mntDate" type="date" class="mt-1 w-full" />
            </div>
            <div>
              <label class="text-sm text-gray-600 dark:text-gray-300">Tipo</label>
              <select id="mntType" class="mt-1 w-full">
                <option value="Revisión">Revisión</option>
                <option value="ITV">ITV</option>
                <option value="Aceite">Aceite</option>
                <option value="Neumáticos">Neumáticos</option>
                <option value="Frenos">Frenos</option>
                <option value="Otro">Otro</option>
              </select>
            </div>
            <div>
              <label class="text-sm text-gray-600 dark:text-gray-300">Coste (€)</label>
              <input id="mntCost" type="number" min="0" step="0.01" class="mt-1 w-full" />
            </div>
            <div class="md:col-span-2">
              <label class="text-sm text-gray-600 dark:text-gray-300">Notas</label>
              <input id="mntNotes" type="text" placeholder="Detalle opcional" class="mt-1 w-full" />
            </div>
          </div>
          <div class="flex gap-2 pt-2">
            <button id="btnAddMnt" class="px-4 py-2 rounded-lg bg-primary text-white hover:bg-primary/90 transition">
              <span class="material-symbols-outlined align-middle mr-1">add</span> Añadir mantenimiento
            </button>
          </div>
          <p class="text-xs text-gray-500">* Este mantenimiento se guardará con tu usuario en <code>createdBy</code>
            para que el Dashboard solo alerte sobre los tuyos.</p>
        </div>

        <!-- Lista de mantenimientos -->
        <div class="mt-4 bg-white dark:bg-background-dark/50 rounded-xl shadow-sm p-4 space-y-3">
          <h3 class="text-base font-bold text-gray-900 dark:text-white">Historial de Mantenimientos</h3>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead>
                <tr class="text-left text-gray-600 dark:text-gray-300">
                  <th class="py-2 pr-4">Fecha</th>
                  <th class="py-2 pr-4">Tipo</th>
                  <th class="py-2 pr-4">Coste (€)</th>
                  <th class="py-2 pr-4">Notas</th>
                  <th class="py-2 pr-4">Creado por</th>
                  <th class="py-2 pr-4">Acciones</th>
                </tr>
              </thead>
              <tbody id="mntTableBody" class="text-gray-800 dark:text-gray-100">
                <!-- filas por JS -->
              </tbody>
            </table>
          </div>
        </div>
      </section>

    </main>

    <!-- FAB -->
    <div class="fixed bottom-20 right-4 z-10">
      <button id="fab"
        class="flex items-center justify-center h-14 w-14 rounded-full bg-primary text-white shadow-lg hover:bg-primary/90 transition-all duration-300 group"
        title="Acción rápida">
        <span
          class="material-symbols-outlined text-3xl group-hover:rotate-90 transition-transform duration-300">add</span>
      </button>
    </div>

    <!-- Barra inferior -->
    <footer
      class="fixed bottom-0 left-0 right-0 border-t bg-background-light dark:bg-background-dark border-border-light dark:border-border-dark">
      <nav class="flex justify-around p-3">
        <a class="flex flex-1 flex-col items-center justify-center gap-1 rounded-lg py-2 text-primary"
          href="dashboard.html">
          <span class="material-symbols-outlined">home</span><span class="text-xs font-medium">Inicio</span>
        </a>
        <a class="flex flex-1 flex-col items-center justify-center gap-1 rounded-lg py-2 text-gray-500 dark:text-gray-400"
          href="gestiondeRutas.html">
          <span class="material-symbols-outlined">map</span><span class="text-xs font-medium">Rutas</span>
        </a>
        <a class="flex flex-1 flex-col items-center justify-center gap-1 rounded-lg py-2 text-gray-500 dark:text-gray-400"
          href="gestiondeViajesDiscrecionales.html">
          <span class="material-symbols-outlined">work</span><span class="text-xs font-medium">Viajes</span>
        </a>
        <a class="flex flex-1 flex-col items-center justify-center gap-1 rounded-lg py-2 text-gray-500 dark:text-gray-400"
          href="gestiondeFlota.html">
          <span class="material-symbols-outlined">directions_bus</span><span class="text-xs font-medium">Flota</span>
        </a>
        <a class="flex flex-1 flex-col items-center justify-center gap-1 rounded-lg py-2 text-gray-500 dark:text-gray-400"
          href="gestiondeEmpleados.html">
          <span class="material-symbols-outlined">group</span><span class="text-xs font-medium">Empleados</span>
        </a>
      </nav>
    </footer>
  </div>

  <!-- ======= LÓGICA ======= -->
  <script>
    /* ------------------ Config / Identidad ------------------ */
    const LS_KEY = 'flota_autobuses_v1';
    // Identificador del usuario actual: si no existe, lo pedimos una vez y lo guardamos
    let CURRENT_USER_ID = localStorage.getItem('current_user_id');
    if (!CURRENT_USER_ID) {
      CURRENT_USER_ID = prompt("Introduce tu identificador de usuario (por ejemplo: admin, Blanca, usuario1):") || "usuario1";
      localStorage.setItem('current_user_id', CURRENT_USER_ID);
      alert(`✅ Usuario configurado como: ${CURRENT_USER_ID}`);
    }


    /* ------------------ Seed opcional (solo si no hay nada) ------------------ */
    const seedBuses = [
      {
        id: 'bus-1234', plate: '1234 ABC', model: 'Mercedes-Benz Citaro Hybrid', km: 215000, seats: 55,
        img: "https://images.unsplash.com/photo-1570125909517-53cb21c89581?q=80&w=600&auto=format&fit=crop", // Bus blanco moderno
        maintenance: []
      },
      {
        id: 'bus-5678', plate: '5678 DEF', model: 'Volvo 9700 Luxury', km: 178400, seats: 59,
        img: "https://images.unsplash.com/photo-1544620347-c4fd4a3d5957?q=80&w=600&auto=format&fit=crop", // Bus naranja/viaje
        maintenance: []
      },
      {
        id: 'bus-9012', plate: '9012 GHI', model: 'Scania Irizar i8', km: 242050, seats: 63,
        img: "https://images.unsplash.com/photo-1543466355-d477fc28a7db?q=80&w=600&auto=format&fit=crop", // Autocar azul
        maintenance: []
      }
    ];

    document.getElementById('backBtn')?.addEventListener('click', () => {
      if (currentBusId) closeBus();
      else window.location.href = 'dashboard.html';
    });
  </script>
  <script src="db-seed.js"></script>
  <script>
    if (window.SeedDB) SeedDB.ensure();

    /* ------------------ Persistencia ------------------ */
    /* ------------------ Persistencia (API) ------------------ */
    async function refreshFleet() {
      try {
        const data = await ApiClient.getBuses();
        // Mapper backend -> frontend
        buses = data.map(b => ({
          id: b.id, // ID real numérico si quieres, o `bus-${b.id}`
          _id: b.id, // Guardamos ID original
          plate: b.matricula,
          model: b.modelo,
          km: b.kilometros_totales,
          seats: b.capacidad,
          img: b.imagen,
          maintenance: [] // Se cargan bajo demanda en detalle
        }));
        renderFleet();
      } catch (err) { console.error(err); alert('Error cargando flota'); }
    }

    // Init
    let buses = [];
    refreshFleet();

    /* ------------------ Migración: asegurar seats y createdBy en mnt y actualizar FOTOS ------------------ */
    function migrate(list) {
      // Pool ampliado y verificado (15 imágenes)
      const newImages = [
        "https://images.unsplash.com/photo-1544620347-c4fd4a3d5957?q=80&w=600&auto=format&fit=crop", // Naranja (ok)
        "https://images.unsplash.com/photo-1557223562-6c77ef16210f?q=80&w=600&auto=format&fit=crop", // Azul (ok)
        "https://images.unsplash.com/photo-1600793575654-910699b5e4d4?q=80&w=600&auto=format&fit=crop", // Amarillo (ok)
        "https://images.unsplash.com/photo-1509749837427-ac94a02d8fca?q=80&w=600&auto=format&fit=crop", // Viaje (ok)
        "https://images.unsplash.com/photo-1570125909232-eb2be3b3b2f8?q=80&w=600&auto=format&fit=crop", // Blanco (try)
        "https://images.unsplash.com/photo-1494515744325-68b21fe966ff?q=80&w=600&auto=format&fit=crop", // Turista (ok)
        "https://images.unsplash.com/photo-1464219789935-c2d9d9aba644?q=80&w=600&auto=format&fit=crop", // Escolar (ok)
        "https://images.unsplash.com/photo-1517153192931-137b25121df4?q=80&w=600&auto=format&fit=crop", // Urbano (ok)
        "https://images.unsplash.com/photo-1525962898597-a4ae6402826e?q=80&w=600&auto=format&fit=crop", // Clásico
        "https://images.unsplash.com/photo-1568738351265-c7065f5d63dc?q=80&w=600&auto=format&fit=crop", // Viaje
        "https://images.unsplash.com/photo-1596426372332-6a7516801901?q=80&w=600&auto=format&fit=crop", // Verde
        "https://images.unsplash.com/photo-1532939163844-547f958e91b4?q=80&w=600&auto=format&fit=crop", // Escolar2
        "https://images.unsplash.com/photo-1519817914152-22d216bb9170?q=80&w=600&auto=format&fit=crop", // Noche
        "https://images.unsplash.com/photo-1549480119-a1b7e0d3c013?q=80&w=600&auto=format&fit=crop", // Plateado
        "https://images.unsplash.com/photo-1574888365676-e41797c55c3c?q=80&w=600&auto=format&fit=crop"  // Doble piso
      ];

      // Flag para forzar actualización una vez
      const MIGRATION_KEY = 'fleet_images_fixed_v3';
      const alreadyFixed = localStorage.getItem(MIGRATION_KEY);

      const migrated = (list || []).map((b, idx) => {
        const seats = (typeof b.seats === 'number' && b.seats > 0) ? b.seats : 55;

        // Si no hemos migrado aún, O si la imagen actual es una de las "viejas" o genéricas, forzamos la nueva
        let img = b.img;
        const isUnsplash = (img && img.includes('unsplash.com'));
        // Si es la primera vez que corremos este fix, reseteamos CUALQUIER imagen de unsplash (asumiendo que es generada)
        // para garantizar que se distribuyan bien (uno para cada uno).
        if (!alreadyFixed && isUnsplash) {
          img = newImages[idx % newImages.length];
        }
        // Fallback normal por si viene vacía
        else if (!img || img.length < 10) {
          img = newImages[idx % newImages.length];
        }

        const maintenance = (b.maintenance || []).map(m => ({
          id: m.id || ('mnt-' + crypto.randomUUID()),
          date: m.date || '',
          type: m.type || 'Otro',
          cost: typeof m.cost === 'number' ? m.cost : 0,
          notes: m.notes || '',
          createdBy: m.createdBy || 'unknown'
        }));
        return { ...b, seats, maintenance, img };
      });

      if (!alreadyFixed) {
        localStorage.setItem(MIGRATION_KEY, 'true');
        // Importante: Guardar el estado migrado inmediatamente para que persista
        localStorage.setItem(LS_KEY, JSON.stringify(migrated));
      }
      return migrated;
    }

    /* ------------------ Helpers UI ------------------ */
    const qs = s => document.querySelector(s);
    const qsa = s => [...document.querySelectorAll(s)];

    const viewFleet = qs('#viewFleet');
    const viewBus = qs('#viewBus');
    const title = qs('#title');
    const backBtn = qs('#backBtn');
    const busList = qs('#busList');
    const btnNewBus = qs('#btnNewBus');

    /* Detalle refs */
    const busImg = qs('#busImg');
    const busPlate = qs('#busPlate');
    const busModel = qs('#busModel');

    const inpPlate = qs('#inpPlate');
    const inpModel = qs('#inpModel');
    const inpKm = qs('#inpKm');
    const inpSeats = qs('#inpSeats');
    const inpImg = qs('#inpImg');

    const mntDate = qs('#mntDate');
    const mntType = qs('#mntType');
    const mntCost = qs('#mntCost');
    const mntNotes = qs('#mntNotes');
    const mntTableBody = qs('#mntTableBody');

    const btnSaveStay = qs('#btnSaveStay');
    const btnSaveBack = qs('#btnSaveBack');
    const btnDeleteBus = qs('#btnDeleteBus');
    const btnAddMnt = qs('#btnAddMnt');
    const fab = qs('#fab');

    // let buses = loadState(); // Removed old sync load
    // buses initialized above in refreshFleet calls
    // let currentBusId = null; (already defined?)
    // currentBusId was defined at line 365. Let's make sure it's valid.
    let currentBusId = null;

    /* ------------------ Render Lista ------------------ */
    function renderFleet() {
      busList.innerHTML = '';
      if (!buses.length) {
        busList.innerHTML = `<div class="p-4 text-sm text-gray-600 dark:text-gray-300 transform transition-all hover:scale-105">No hay autobuses. Crea uno con “Nuevo bus”.</div>`;
        return;
      }

      // URLs fiables de autobuses
      // URLs fiables de autobuses
      const busImages = [
        "https://images.unsplash.com/photo-1544620347-c4fd4a3d5957?q=80&w=600&auto=format&fit=crop", // Naranja
        "https://images.unsplash.com/photo-1570125909232-eb2be3b3b2f8?q=80&w=600&auto=format&fit=crop", // Blanco
        "https://images.unsplash.com/photo-1494515744325-68b21fe966ff?q=80&w=600&auto=format&fit=crop", // Turista
        "https://images.unsplash.com/photo-1517153192931-137b25121df4?q=80&w=600&auto=format&fit=crop", // Urbano
        "https://images.unsplash.com/photo-1600793575654-910699b5e4d4?q=80&w=600&auto=format&fit=crop", // Amarillo
        "https://images.unsplash.com/photo-1563820623366-512534575b6d?q=80&w=600&auto=format&fit=crop", // Rojo
        "https://images.unsplash.com/photo-1557223562-6c77ef16210f?q=80&w=600&auto=format&fit=crop", // Azul
        "https://images.unsplash.com/photo-1549480119-a1b7e0d3c013?q=80&w=600&auto=format&fit=crop", // Plateado
        "https://images.unsplash.com/photo-1525962898597-a4ae6402826e?q=80&w=600&auto=format&fit=crop", // Clásico
        "https://images.unsplash.com/photo-1596426372332-6a7516801901?q=80&w=600&auto=format&fit=crop", // Verde
        "https://images.unsplash.com/photo-1606185540834-d6f65bc71947?q=80&w=600&auto=format&fit=crop", // Moderno
        "https://images.unsplash.com/photo-1532939163844-547f958e91b4?q=80&w=600&auto=format&fit=crop", // Escolar
        "https://images.unsplash.com/photo-1509749837427-ac94a02d8fca?q=80&w=600&auto=format&fit=crop", // Viaje largo
        "https://images.unsplash.com/photo-1519817914152-22d216bb9170?q=80&w=600&auto=format&fit=crop", // Noche
        "https://images.unsplash.com/photo-1574888365676-e41797c55c3c?q=80&w=600&auto=format&fit=crop"  // Doble piso
      ];

      buses.forEach((b, idx) => {
        const a = document.createElement('a');
        a.href = '#';
        a.className = 'flex items-center gap-4 group p-3 rounded-lg hover:bg-slate-50 dark:hover:bg-white/5 transition-all';
        a.onclick = (e) => { e.preventDefault(); openBus(b.id); };

        const fallbackImg = busImages[idx % busImages.length];
        // Usar la imagen del bus, o fallback si no tiene.
        // Si tiene, intentamos cargarla. Si falla el img tag, saltará a fallback.
        const displayImg = (b.img && b.img.length > 10) ? b.img : fallbackImg;

        const img = document.createElement('div');
        img.className = 'w-24 h-24 rounded-xl shadow-sm shrink-0 bg-gray-200 dark:bg-gray-700 overflow-hidden relative';
        // Usamos IMG tag para poder detectar errores de carga (404)
        img.innerHTML = `<img src="${displayImg}" alt="Bus" class="w-full h-full object-cover transition-transform group-hover:scale-110 duration-500" onerror="this.onerror=null;this.src='${fallbackImg}';">`;

        const info = document.createElement('div');
        info.className = 'flex-1';
        info.innerHTML = `
          <p class="text-lg font-bold text-gray-900 dark:text-white mb-1 group-hover:text-primary transition-colors">${b.plate}</p>
          <p class="text-sm text-gray-600 dark:text-gray-400 font-medium">${b.model}</p>
          <p class="text-xs text-gray-500 dark:text-gray-500 mt-1 flex items-center gap-1">
             <span class="material-symbols-outlined text-[1rem]">airline_seat_recline_extra</span> ${b.seats} plazas
          </p>
        `;

        const chev = document.createElement('span');
        chev.className = 'material-symbols-outlined text-gray-400 dark:text-gray-500 group-hover:text-primary transition-colors text-2xl';
        chev.textContent = 'chevron_right';

        a.appendChild(img);
        a.appendChild(info);
        a.appendChild(chev);
        busList.appendChild(a);
      });
    }

    /* ------------------ Navegación vistas ------------------ */
    function showFleet() {
      currentBusId = null;
      title.textContent = 'Flota';
      backBtn.classList.add('invisible');
      viewBus.classList.add('hidden');
      viewFleet.classList.remove('hidden');
    }
    function showBus() {
      backBtn.classList.remove('invisible');
      viewFleet.classList.add('hidden');
      viewBus.classList.remove('hidden');
    }

    async function loadMaintenanceForBus(busId) {
      try {
        const mants = await ApiClient.getMaintenances(busId);
        // Guardamos en el objeto bus local para renderizar
        const b = buses.find(x => x.id === busId);
        if (b) {
          b.maintenance = mants.map(m => ({
            id: m.id, deleteId: m.id,
            date: m.fecha_programada || m.fecha_realizacion,
            type: m.tipo,
            cost: m.coste,
            notes: m.descripcion,
            createdBy: m.created_by
          }));
          renderMaintenance();
        }
      } catch (e) {
        console.error(e);
        // If 404/error, just clear
        const b = buses.find(x => x.id === busId);
        if (b) { b.maintenance = []; renderMaintenance(); }
      }
    }

    // ...

    async function loadMaintenanceForBus(busId) {
      try {
        const mants = await ApiClient.getMaintenances(busId);
        // Guardamos en el objeto bus local para renderizar
        const b = buses.find(x => x.id === busId);
        if (b) {
          b.maintenance = mants.map(m => ({
            id: m.id, deleteId: m.id,
            date: m.fecha_programada || m.fecha_realizacion,
            type: m.tipo,
            cost: m.coste,
            notes: m.descripcion,
            createdBy: m.created_by
          }));
          renderMaintenance();
        }
      } catch (e) { console.error(e); }
    }

    function renderMaintenance() {
      const b = buses.find(x => x.id === currentBusId);
      mntTableBody.innerHTML = '';
      if (!b || b.maintenance.length === 0) {
        mntTableBody.innerHTML = `<tr><td colspan="6" class="py-3 text-gray-500">Sin registros.</td></tr>`;
        return;
      }
      b.maintenance
        .slice()
        .sort((a, c) => (c.date || '').localeCompare(a.date || '')) // desc por fecha
        .forEach((m) => {
          const tr = document.createElement('tr');
          tr.className = 'border-t border-gray-100 dark:border-white/10';
          tr.innerHTML = `
        <td class="py-2 pr-4">${m.date || '—'}</td>
        <td class="py-2 pr-4">${m.type || '—'}</td>
        <td class="py-2 pr-4">${(m.cost ?? 0).toFixed(2)}</td>
        <td class="py-2 pr-4">${m.notes || ''}</td>
        <td class="py-2 pr-4">${m.createdBy || 'unknown'}</td>
        <td class="py-2 pr-4">
          <button class="text-red-600 hover:underline text-sm" data-del="${m.id}">Eliminar</button>
        </td>
      `;
          mntTableBody.appendChild(tr);
        });

      // Bind borrar
      qsa('button[data-del]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-del');
          deleteMaintenance(id);
        });
      });
    }

    /* ------------------ Acciones: Guardar / Mantenimiento ------------------ */
    function collectBusForm() {
      return {
        plate: (inpPlate.value || '').trim(),
        model: (inpModel.value || '').trim(),
        km: Number(inpKm.value || 0),
        seats: Math.max(8, parseInt(inpSeats.value || '55', 10) || 55),
        img: (inpImg.value || '').trim()
      };
    }
    /* ------------------ Guardar Edición ------------------ */
    async function saveBus(returnToFleet = false) {
      const data = collectBusForm();
      if (!data.plate || !data.model) { alert('Datos incompletos'); return; }

      try {
        await ApiClient.updateBus(currentBusId, {
          matricula: data.plate,
          modelo: data.model,
          capacidad: data.seats,
          kilometros_totales: data.km,
          imagen: data.img
          // activo/estado faltaría si lo editamos
        });

        await refreshFleet(); // Recargar listado

        if (returnToFleet) {
          showFleet();
        } else {
          alert('Guardado correctamente');
        }
      } catch (e) { alert('Error guardando: ' + e.message); }
    }

    async function addMaintenance() {
      // Validar inputs
      if (!mntDate.value) { alert('Fecha requerida'); return; }

      try {
        const bus = buses.find(x => x.id === currentBusId);
        // bus.id es string "bus-123" o numero? Backend espera ID numérico seguramente
        // El seed usaba IDs numericos. 
        // En refreshFleet mapeamos: id: b.id (numero)

        await ApiClient.createMaintenance({
          autobus_id: bus._id || bus.id, // ID backend
          fecha_programada: mntDate.value,
          tipo: mntType.value,
          coste: parseFloat(mntCost.value) || 0,
          descripcion: mntNotes.value,
          created_by: CURRENT_USER_ID,
          estado: 'pendiente'
        });

        // Limpiar inputs
        mntDate.value = '';
        mntCost.value = '';
        mntNotes.value = '';

        // Recargar
        await loadMaintenanceForBus(currentBusId);

      } catch (e) { alert('Error creando mant: ' + e.message); }
    }

    async function deleteMaintenance(mntId) {
      if (!confirm('¿Borrar mantenimiento?')) return;
      try {
        await ApiClient.deleteMaintenance(mntId);
        // Recargar solo mantenimientos
        await loadMaintenanceForBus(currentBusId);
      } catch (e) { alert('Error eliminando mantenimiento: ' + e.message); }
    }

    async function deleteBus() {
      if (!currentBusId) return;
      if (!confirm('¿Eliminar este autobús y su historial?')) return;

      try {
        await ApiClient.deleteBus(currentBusId);
        await refreshFleet();
        showFleet();
      } catch (e) { alert('Error eliminando: ' + e.message); }
    }

    /* ------------------ Alta de bus ------------------ */
    /* ------------------ Alta de bus ------------------ */
    async function createNewBusDialog() {
      const plate = prompt('Matrícula del nuevo autobús:');
      if (!plate) return;
      const model = prompt('Modelo:') || 'Modelo';
      const seats = parseInt(prompt('Plazas:') || '55');

      try {
        await ApiClient.createBus({
          matricula: plate,
          modelo: model,
          capacidad: seats,
          estado: 'operativo'
        });
        await refreshFleet();
        alert('Autobús creado');
      } catch (e) { alert('Error creando: ' + e.message); }
    }

    /* ------------------ Eventos ------------------ */
    backBtn.addEventListener('click', showFleet);
    btnSaveStay.addEventListener('click', () => saveBus(false));
    btnSaveBack.addEventListener('click', () => saveBus(true));
    btnDeleteBus.addEventListener('click', deleteBus);
    btnAddMnt.addEventListener('click', addMaintenance);
    btnNewBus.addEventListener('click', createNewBusDialog);

    fab.addEventListener('click', () => {
      if (currentBusId) {
        // En detalle: enfoca fecha hoy
        mntDate.value = new Date().toISOString().slice(0, 10);
        mntNotes.focus();
      } else {
        createNewBusDialog();
      }
    });

    /* ------------------ Init ------------------ */
    renderFleet();
    showFleet();
  </script>
  <script src="api-sync.js"></script>
  <script src="app-ui.js"></script>
  <style>
    /* Quick fix to center the Add Bus button as requested */
    #viewFleet>div:first-child {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    #viewFleet>div:first-child>h2 {
      width: auto;
    }

    #viewFleet>div:first-child>button {
      position: static;
      transform: none;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      border-radius: 9999px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
  </style>
</body>

</html>