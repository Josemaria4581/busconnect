<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestión de Viajes Discrecionales - Funcional</title>

  <!-- Fonts & Tailwind -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?display=swap&family=Noto+Sans:wght@400;500;700;900&family=Work+Sans:wght@400;500;700;900"
    rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#1173d4",
            "background-light": "#f6f7f8",
            "background-dark": "#101922",
          },
          fontFamily: { display: ["Work Sans"] },
          borderRadius: { DEFAULT: "0.25rem", lg: "0.5rem", xl: "0.75rem", full: "9999px" }
        }
      }
    }
  </script>
  <style>
    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24
    }

    .form-select {
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%231173d4' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 0.5rem center;
      background-repeat: no-repeat;
      background-size: 1.5em 1.5em;
      padding-right: 2.5rem;
      -webkit-print-color-adjust: exact;
      color-adjust: exact;
    }

    body {
      min-height: max(884px, 100dvh);
    }

    .toast {
      position: fixed;
      bottom: 88px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      display: none;
    }
  </style>
  <!-- jsPDF se cargará dinámicamente desde gestion-discrecionales.js si hace falta -->
</head>

<body class="bg-background-light dark:bg-background-dark font-display">
  <div class="relative flex min-h-screen w-full flex-col justify-between overflow-x-hidden">
    <div class="flex-grow">
      <header
        class="flex items-center bg-background-light dark:bg-background-dark p-4 pb-2 justify-between sticky top-0 z-10 border-b border-slate-200 dark:border-slate-800">
        <button id="btnBack"
          class="text-slate-800 dark:text-white flex size-10 shrink-0 items-center justify-center rounded-full hover:bg-primary/10"
          title="Volver">
          <span class="material-symbols-outlined">arrow_back</span>
        </button>
        <h1 class="text-slate-900 dark:text-white text-lg font-bold flex-1 text-center">Gestión de Viajes Discrecionales
        </h1>
        <button id="btnMore"
          class="text-slate-800 dark:text-white flex size-10 shrink-0 items-center justify-center rounded-full hover:bg-primary/10"
          title="Más opciones">
          <span class="material-symbols-outlined">more_vert</span>
        </button>
      </header>

      <main class="p-4 space-y-6">
        <!-- Detalles -->
        <section class="bg-white dark:bg-slate-800 rounded-xl shadow-sm p-4">
          <h2 class="text-slate-900 dark:text-white font-bold text-xl mb-4">Detalles de la Solicitud</h2>
          <div class="space-y-4">
            <div>
              <label for="origen" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Origen</label>
              <div class="relative mt-1">
                <input id="origen" type="text" value="Plaza de España, Madrid"
                  placeholder="Introduce la dirección de origen"
                  class="w-full pl-10 pr-4 py-2 border border-slate-300 dark:border-slate-700 rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-slate-700 dark:text-white" />
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <span class="material-symbols-outlined text-slate-400">my_location</span>
                </div>
              </div>
            </div>
            <div>
              <label for="destino" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Destino</label>
              <div class="relative mt-1">
                <input id="destino" type="text" value="Aeropuerto de Barajas, Madrid"
                  placeholder="Introduce la dirección de destino"
                  class="w-full pl-10 pr-4 py-2 border border-slate-300 dark:border-slate-700 rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-slate-700 dark:text-white" />
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <span class="material-symbols-outlined text-slate-400">flag</span>
                </div>
              </div>
            </div>

            <div id="mapa" class="relative h-48 rounded-lg overflow-hidden"></div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
              <div>
                <label for="salida" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Fecha y hora de
                  salida</label>
                <input id="salida" type="datetime-local"
                  class="mt-1 block w-full border border-slate-300 dark:border-slate-700 rounded-md shadow-sm p-2 dark:bg-slate-700 dark:text-white" />
              </div>
              <div>
                <label for="llegada" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Fecha y hora
                  de llegada</label>
                <input id="llegada" type="datetime-local"
                  class="mt-1 block w-full border border-slate-300 dark:border-slate-700 rounded-md shadow-sm p-2 dark:bg-slate-700 dark:text-white" />
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label for="plazas" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Nº de
                  Plazas</label>
                <input id="plazas" type="number" value="55"
                  class="mt-1 block w-full border border-slate-300 dark:border-slate-700 rounded-md shadow-sm p-2 dark:bg-slate-700 dark:text-white" />
              </div>
              <div>
                <label for="dias" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Días
                  (auto)</label>
                <input id="dias" type="number" value="1" readonly
                  class="mt-1 block w-full border border-slate-300 dark:border-slate-700 rounded-md shadow-sm p-2 dark:bg-slate-700 dark:text-white bg-slate-100 dark:bg-slate-800" />
              </div>
            </div>
          </div>
        </section>

        <!-- Resumen y Pago -->
        <section class="bg-white dark:bg-slate-800 rounded-xl shadow-sm p-4">
          <h2 class="text-slate-900 dark:text-white font-bold text-xl mb-4">Resumen y Pago</h2>
          <div class="space-y-3 text-slate-600 dark:text-slate-300">
            <div class="flex justify-between">
              <span>Coste por kilómetro:</span>
              <span id="costeKilometro" class="font-medium text-slate-800 dark:text-white">0,00 €</span>
            </div>
            <div class="flex justify-between">
              <span>Coste total del viaje:</span>
              <span id="costeTotal" class="font-medium text-slate-800 dark:text-white">0,00 €</span>
            </div>
            <div class="flex justify-between items-center text-primary">
              <span class="font-bold">Pago adelantado (20%):</span>
              <span id="pagoAdelantado" class="font-bold text-lg">0,00 €</span>
            </div>
            <div class="flex justify-between">
              <span>Monto restante:</span>
              <span id="montoRestante" class="font-medium text-slate-800 dark:text-white">0,00 €</span>
            </div>
            <div class="flex justify-between items-center">
              <span>Estado del pago:</span>
              <span id="estadoPago"
                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">
                <span class="material-symbols-outlined text-sm mr-1">pending</span>
                Pendiente
              </span>
            </div>
            <div class="flex gap-2 pt-2">
              <button id="btnMarcarPagado"
                class="px-3 py-1.5 rounded-lg bg-green-600 text-white text-sm hover:bg-green-700">Marcar como
                pagado</button>
              <button id="btnRecalcular"
                class="px-3 py-1.5 rounded-lg bg-slate-200 dark:bg-slate-700 text-sm hover:bg-slate-300 dark:hover:bg-slate-600">Recalcular</button>
              <button id="btnGenerarResumen"
                class="px-3 py-1.5 rounded-lg bg-primary text-white text-sm hover:bg-primary/90 flex items-center gap-1"
                title="Generar solicitud">
                <span class="material-symbols-outlined">send_and_archive</span>
                Generar solicitud
              </button>
            </div>
          </div>
        </section>

        <!-- Mensajería -->
        <section class="bg-white dark:bg-slate-800 rounded-xl shadow-sm p-4">
          <h2 class="text-slate-900 dark:text-white font-bold text-xl mb-4">Mensajería con el Cliente
            <span id="badgeUnread"
              class="ml-2 align-middle text-xs font-bold px-2 py-0.5 rounded-full bg-primary/10 text-primary hidden">Nuevo</span>
          </h2>

          <div data-chat class="space-y-4 max-h-60 overflow-auto pr-1">
            <!-- el historial se inyecta desde JS -->
          </div>

          <div class="mt-3 flex items-center gap-2">
            <button data-chat-attach
              class="text-slate-500 dark:text-slate-400 flex size-10 shrink-0 items-center justify-center rounded-full hover:bg-slate-100 dark:hover:bg-slate-700"
              title="Adjuntar archivo">
              <span class="material-symbols-outlined">attach_file</span>
            </button>
            <input data-chat-file type="file" class="hidden" />
            <div class="relative flex-1">
              <input data-chat-input type="text" placeholder="Escribe un mensaje..."
                class="w-full pl-4 pr-12 py-2 border border-slate-300 dark:border-slate-700 rounded-full shadow-sm focus:ring-primary focus:border-primary dark:bg-slate-700 dark:text-white" />
              <button data-chat-send
                class="absolute inset-y-0 right-0 flex items-center justify-center size-10 text-primary hover:bg-primary/10 rounded-full"
                title="Enviar">
                <span class="material-symbols-outlined">send</span>
              </button>
            </div>
          </div>
        </section>

        <button id="btnGenerar"
          class="w-full bg-primary text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 hover:bg-primary/90 mt-2">
          <span class="material-symbols-outlined">send_and_archive</span>
          Generar Solicitud de Viaje
        </button>
      </main>
    </div>

    <footer
      class="fixed bottom-0 left-0 right-0 border-t bg-background-light dark:bg-background-dark border-slate-200 dark:border-slate-800">
      <nav class="flex justify-around p-3">
        <a id="navInicio"
          class="flex flex-1 flex-col items-center justify-center gap-1 rounded-lg py-2 text-slate-500 dark:text-slate-400"
          href="dashboard.html">
          <span class="material-symbols-outlined">home</span>
          <span class="text-xs font-medium">Inicio</span>
        </a>
        <a id="navRutas"
          class="flex flex-1 flex-col items-center justify-center gap-1 rounded-lg py-2 text-slate-500 dark:text-slate-400"
          href="gestiondeRutas.html">
          <span class="material-symbols-outlined">map</span>
          <span class="text-xs font-medium">Rutas</span>
        </a>
        <a id="navViajes"
          class="flex flex-1 flex-col items-center justify-center gap-1 rounded-lg py-2 bg-primary/10 text-primary dark:bg-primary/20"
          href="gestiondeViajesDiscrecionales.html">
          <span class="material-symbols-outlined">work</span>
          <span class="text-xs font-bold">Viajes</span>
        </a>
        <a id="navFlota"
          class="flex flex-1 flex-col items-center justify-center gap-1 rounded-lg py-2 text-slate-500 dark:text-slate-400"
          href="gestiondeFlota.html">
          <span class="material-symbols-outlined">directions_bus</span>
          <span class="text-xs font-medium">Flota</span>
        </a>
        <a id="navEmpleados"
          class="flex flex-1 flex-col items-center justify-center gap-1 rounded-lg py-2 text-slate-500 dark:text-slate-400"
          href="gestiondeEmpleados.html">
          <span class="material-symbols-outlined">group</span>
          <span class="text-xs font-medium">Empleados</span>
        </a>
      </nav>
    </footer>
    <!-- Toast -->
    <div id="toast" class="toast">
      <div class="rounded-full bg-slate-900/90 text-white text-sm px-4 py-2 shadow-lg backdrop-blur">
        <span id="toastMsg">Acción realizada</span>
      </div>
    </div>

    <script src="db-seed.js"></script>
    <script>
      if (window.SeedDB) SeedDB.ensure();
    </script>

    <!-- Lógica Principal -->
    <script>
      (function guardByRole() {
        const role = localStorage.getItem('role');
        if (!role) { window.location.href = 'inicioSesion.html'; return; }
        if (role === 'conductor') { window.location.href = 'aplicacionConductor.html'; return; }
        if (role === 'cliente') {
          const hideIds = ['navInicio', 'navFlota', 'navEmpleados'];
          hideIds.forEach(id => { const el = document.getElementById(id); if (el) el.style.display = 'none'; });
        }
        const btnGen = document.getElementById('btnGenerar');
        if (btnGen) btnGen.style.display = (role === 'cliente') ? '' : 'none';
        const btnGenRes = document.getElementById('btnGenerarResumen');
        if (btnGenRes) btnGenRes.style.display = (role === 'cliente') ? '' : 'none';
      })();
    </script>

    <script src="gestion-discrecionales.js"></script>

    <script>
      // Helper de toast para esta página (centro-arriba, 5s)
      (function ensureToast() {
        if (window.showToast) return;
        function host() {
          let h = document.getElementById('toast-host');
          if (!h) {
            h = document.createElement('div');
            h.id = 'toast-host';
            h.style.position = 'fixed';
            h.style.bottom = '90px';
            h.style.left = '50%';
            h.style.transform = 'translateX(-50%)';
            h.style.zIndex = '9999';
            h.style.pointerEvents = 'none';
            document.body.appendChild(h);
          }
          return h;
        }
        window.showToast = function (msg, ms) {
          const h = host();
          const b = document.createElement('div');
          b.textContent = msg;
          b.style.background = 'rgba(17,17,17,.92)';
          b.style.color = '#fff';
          b.style.font = "500 13px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu";
          b.style.padding = '8px 12px';
          b.style.borderRadius = '9999px';
          b.style.margin = '6px 0';
          b.style.boxShadow = '0 6px 20px rgba(0,0,0,.25)';
          b.style.display = 'inline-block';
          b.style.cursor = 'pointer';
          b.title = 'Click para cerrar';
          h.appendChild(b);
          b.addEventListener('click', () => b.remove());
          if (typeof ms === 'number' && ms > 0) setTimeout(() => b.remove(), ms);
        }
      })();

      // Avisos al cliente cuando admin acepta/rechaza
      (function clientNotifs() {
        const LS_USER = 'current_user_id';
        const LS_NOTIFS = 'notificaciones_v1';
        function me() { return localStorage.getItem(LS_USER) || ''; }
        function readList() { try { return JSON.parse(localStorage.getItem(LS_NOTIFS) || '[]'); } catch { return []; } }
        function markReadForMe() { const m = me(); const l = readList(); let ch = false; l.forEach(n => { if (!n.read && n.to === m) { n.read = true; ch = true; } }); if (ch) localStorage.setItem(LS_NOTIFS, JSON.stringify(l)); }
        function updateBadge() { const m = me(); const l = readList(); const hasUnread = l.some(n => !n.read && n.to === m); const b = document.getElementById('badgeUnread'); if (b) b.style.display = hasUnread ? 'inline-block' : 'none'; }
        function showUnread() { const m = me(); readList().filter(n => !n.read && n.to === m).forEach(n => { try { if (typeof showToast === 'function') showToast(`${n.title}${n.body ? ': ' + n.body : ''}`); } catch { } }); markReadForMe(); updateBadge(); }
        window.addEventListener('DOMContentLoaded', () => { updateBadge(); showUnread(); });
        window.addEventListener('storage', (e) => { if (e.key === 'notificaciones_v1' || e.key === 'notif_ping') { showUnread(); } });
        // Al abrir/chat enviar, limpiamos el badge
        document.addEventListener('click', (e) => { if (e.target.closest('[data-chat]') || e.target.closest('[data-chat-input]')) { markReadForMe(); updateBadge(); } });
      })();
    </script>
  </div>
  <script src="api-sync.js"></script>
  <script src="app-ui.js"></script>
</body>

</html>