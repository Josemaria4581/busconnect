<!DOCTYPE html>
<html class="light" lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Gestión de Mantenimiento</title>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script>
  tailwind.config = {
    darkMode: "class",
    theme: {
      extend: {
        colors: {
          "primary": "#1E88E5",
          "secondary": "#90A4AE",
          "accent": "#FF9800",
          "success": "#4CAF50",
          "warning": "#FFC107",
          "danger": "#F44336",
          "background-light": "#F5F5F5",
          "background-dark": "#101922",
        },
        fontFamily: { "display": ["Manrope", "sans-serif"] },
        borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
      },
    },
  }
</script>
<style>
  .material-symbols-outlined { font-variation-settings:'FILL' 0,'wght' 400,'GRAD' 0,'opsz' 24 }
  body { min-height: max(884px, 100dvh); }
</style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-gray-800 dark:text-gray-200">
<div class="relative flex min-h-screen w-full flex-col overflow-x-hidden">

  <!-- Header -->
  <div class="sticky top-0 z-10 flex items-center bg-background-light dark:bg-background-dark p-4 pb-2 justify-between border-b border-gray-200 dark:border-gray-700">
    <div class="flex items-center">
      <button id="btnBack" class="flex size-12 shrink-0 items-center justify-center rounded-full text-gray-800 dark:text-gray-200">
        <span class="material-symbols-outlined">arrow_back</span>
      </button>
    </div>
    <h2 class="text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center text-gray-900 dark:text-white">Gestión de Mantenimiento</h2>
    <div class="flex w-12 items-center justify-end"></div>
  </div>

  <div class="p-4 space-y-4">
    <!-- Search -->
    <div class="relative">
      <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">search</span>
      <input id="inpSearch" class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 py-3 pl-10 pr-4 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Buscar por matrícula..." type="text"/>
    </div>

    <!-- KPIs -->
    <div class="flex flex-wrap gap-4">
      <div class="flex min-w-[158px] flex-1 flex-col gap-2 rounded-xl p-4 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
        <p class="text-secondary text-sm font-medium leading-normal">Pendientes</p>
        <p id="kpiPendientes" class="text-accent tracking-light text-2xl font-bold leading-tight">0</p>
      </div>
      <div class="flex min-w-[158px] flex-1 flex-col gap-2 rounded-xl p-4 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
        <p class="text-secondary text-sm font-medium leading-normal">En Progreso</p>
        <p id="kpiProgreso" class="text-warning tracking-light text-2xl font-bold leading-tight">0</p>
      </div>
      <div class="flex min-w-[158px] flex-1 flex-col gap-2 rounded-xl p-4 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
        <p class="text-secondary text-sm font-medium leading-normal">Completados</p>
        <p id="kpiCompletados" class="text-success tracking-light text-2xl font-bold leading-tight">0</p>
      </div>
    </div>

    <!-- Tabs -->
    <div class="pb-3">
      <div class="flex border-b border-gray-200 dark:border-gray-700 justify-between">
        <a id="tabProximos" class="flex flex-col items-center justify-center border-b-[3px] border-b-primary text-primary pb-[13px] pt-4 flex-1 cursor-pointer">
          <p class="text-sm font-bold leading-normal tracking-[0.015em]">Próximos</p>
        </a>
        <a id="tabFijos" class="flex flex-col items-center justify-center border-b-[3px] border-b-transparent text-secondary pb-[13px] pt-4 flex-1 cursor-pointer">
          <p class="text-sm font-bold leading-normal tracking-[0.015em]">Fijos/Recurrentes</p>
        </a>
        <a id="tabHistorial" class="flex flex-col items-center justify-center border-b-[3px] border-b-transparent text-secondary pb-[13px] pt-4 flex-1 cursor-pointer">
          <p class="text-sm font-bold leading-normal tracking-[0.015em]">Historial</p>
        </a>
      </div>
    </div>

    <!-- CABECERA Fijos/Recurrentes -->
    <div id="fijosHeader" class="space-y-4 hidden">
      <div class="flex items-center justify-between">
        <h3 class="text-base font-bold text-gray-900 dark:text-white">Mantenimientos Configurados</h3>
        <button id="btnAddCfg" class="flex h-10 shrink-0 items-center justify-center gap-x-2 rounded-lg bg-primary pl-4 pr-3 text-white">
          <span class="material-symbols-outlined">add</span>
          <p class="text-sm font-medium leading-normal">Añadir</p>
        </button>
      </div>
    </div>

    <!-- Listas -->
    <div id="listContainer" class="space-y-3">
      <!-- tarjetas por JS -->
    </div>
  </div>

  <!-- FAB (alta rápida abre Flota) -->
  <div class="fixed bottom-6 right-6">
    <a href="gestiondeFlota.html" class="flex h-14 w-14 items-center justify-center rounded-full bg-accent text-white shadow-lg">
      <span class="material-symbols-outlined text-3xl">add</span>
    </a>
  </div>

  <!-- ======= Bottom Sheet (menú opciones mantenimiento) ======= -->
  <div id="sheet" class="fixed inset-0 z-30 hidden">
    <div class="absolute inset-0 bg-black/40" id="sheetMask"></div>
    <div class="absolute bottom-0 inset-x-0 bg-white dark:bg-gray-800 rounded-t-xl p-4 shadow-2xl">
      <div class="h-1 w-12 bg-gray-300 dark:bg-gray-600 rounded-full mx-auto mb-3"></div>
      <div class="mb-3">
        <p id="sheetTitle" class="text-base font-bold text-gray-900 dark:text-white">Acciones</p>
        <p id="sheetSub" class="text-sm text-secondary">—</p>
      </div>
      <div class="space-y-2">
        <button id="actAccept" class="w-full flex items-center gap-3 p-3 rounded-lg bg-gray-100 dark:bg-gray-700">
          <span class="material-symbols-outlined">play_arrow</span>
          <span>Aceptar (En progreso)</span>
        </button>
        <button id="actDone" class="w-full flex items-center gap-3 p-3 rounded-lg bg-success/10 text-success">
          <span class="material-symbols-outlined">check_circle</span>
          <span>Marcar como completado</span>
        </button>
        <button id="actReprog" class="w-full flex items-center gap-3 p-3 rounded-lg bg-amber-100 text-amber-700">
          <span class="material-symbols-outlined">event</span>
          <span>Reprogramar fecha…</span>
        </button>
        <button id="actCancel" class="w-full flex items-center gap-3 p-3 rounded-lg bg-danger/10 text-danger">
          <span class="material-symbols-outlined">close</span>
          <span>Cancelar</span>
        </button>
      </div>
    </div>
  </div>

  <!-- ======= Modal simple (Añadir/Editar Recurrente) ======= -->
  <div id="modalCfg" class="fixed inset-0 z-40 hidden">
    <div class="absolute inset-0 bg-black/40" id="modalMask"></div>
    <div class="absolute inset-x-4 top-1/2 -translate-y-1/2 bg-white dark:bg-gray-800 rounded-xl p-4 shadow-2xl max-w-lg mx-auto">
      <h3 id="modalCfgTitle" class="text-base font-bold text-gray-900 dark:text-white mb-3">Añadir recurrente</h3>
      <div class="grid grid-cols-1 gap-3">
        <div>
          <label class="text-sm text-secondary">Tipo</label>
          <select id="cfgType" class="w-full mt-1">
            <option>ITV</option>
            <option>Aceite</option>
            <option>Revisión</option>
            <option>Frenos</option>
            <option>Neumáticos</option>
          </select>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-sm text-secondary">Cada (meses)</label>
            <input id="cfgMonths" type="number" min="1" value="6" class="w-full mt-1"/>
          </div>
          <div>
            <label class="text-sm text-secondary">Aplicar a</label>
            <select id="cfgScope" class="w-full mt-1">
              <option value="all">Toda la flota</option>
              <option value="plate">Sólo matrícula…</option>
            </select>
          </div>
        </div>
        <div id="cfgPlateWrap" class="hidden">
          <label class="text-sm text-secondary">Matrícula</label>
          <input id="cfgPlate" type="text" class="w-full mt-1" placeholder="1234 ABC"/>
        </div>
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button id="cfgCancel" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700">Cancelar</button>
        <button id="cfgSave" class="px-4 py-2 rounded-lg bg-primary text-white">Guardar</button>
      </div>
    </div>
  </div>

</div>

<!-- ======= LÓGICA ======= -->
<script>
/* ===== Claves de almacenamiento ===== */
const LS_BUSES = 'flota_autobuses_v1';
const LS_CFG   = 'mantenimiento_config_v1';     // [{id,type,months,scope,plate?}]
const LS_OVR   = 'mantenimiento_overrides_v1';  // {"PLATE|TYPE":"YYYY-MM-DD"}
const LS_WIP   = 'mantenimiento_enprogreso_v1'; // [{"key","date","note"}]

/* ===== Identidad de usuario (coherente con el dashboard) ===== */
const LS_USER = 'current_user_id';
function getCurrentUserId(){
  let id = localStorage.getItem(LS_USER);
  if (!id) {
    id = 'user-' + (crypto?.randomUUID?.() || Math.random().toString(36).slice(2));
    localStorage.setItem(LS_USER, id);
  }
  return id;
}
const CURRENT_USER_ID = getCurrentUserId();

/* ===== Estado UI ===== */
let currentTab = 'proximos';
let searchText = '';

/* ===== Util ===== */
const qs = s => document.querySelector(s);
const qsa = s => [...document.querySelectorAll(s)];
const todayISO = () => new Date().toISOString().slice(0,10);
const addMonths = (date, n) => { const d = new Date(date); d.setMonth(d.getMonth()+n); return d; };
const daysUntil = (d, ref = new Date()) => {
  const t = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const r = new Date(ref.getFullYear(), ref.getMonth(), ref.getDate());
  return Math.round((t - r)/(1000*60*60*24));
};
const fmt = d => d instanceof Date ? d.toISOString().slice(0,10) : '';
const keyFor = (plate, type) => `${plate}|${type}`;

/* ===== Storage helpers ===== */
const loadJson = (k, def) => { try { return JSON.parse(localStorage.getItem(k)) ?? def; } catch { return def; } };
const saveJson = (k, v) => localStorage.setItem(k, JSON.stringify(v));

/* ===== Datos base ===== */
function loadBuses(){ return loadJson(LS_BUSES, []); }
function allMaint(buses){
  const a=[]; buses.forEach(b=> (b.maintenance||[]).forEach(m=> a.push({...m,_plate:b.plate,_model:b.model})));
  return a;
}
function lastByType(list,type){
  const f=(list||[]).filter(m => (m.type||'').toLowerCase()===type.toLowerCase() && m.date);
  if(!f.length) return null;
  f.sort((a,b)=>(b.date||'').localeCompare(a.date||'')); return f[0];
}

/* ===== Config SIN creación automática por defecto ===== */
function defaultCfgIfEmpty(){
  const cfg = loadJson(LS_CFG, []);
  if (Array.isArray(cfg) && cfg.length) return cfg;
  // Semilla por defecto para que coincida con las alertas del dashboard
  const seeded = [
    { id:'cfg-itv-all', type:'ITV',     months:12, scope:'all' },
    { id:'cfg-aceite-all', type:'Aceite', months:6,  scope:'all' },
    { id:'cfg-revision-all', type:'Revisión', months:12, scope:'all' }
  ];
  return seeded;
}

/* ===== Cálculo Próximos =====
   Origen: overrides -> recurrente (si existe) -> último historial (si existe).
   NO genera nada si no hay historial y no hay override/config.
*/
function computeUpcoming(){
  const buses = loadBuses();
  const cfg = defaultCfgIfEmpty();
  const ovr = loadJson(LS_OVR, {});
  const wip = loadJson(LS_WIP, []);
  const now = new Date();

  const tasks = [];

  function monthsFor(plate, type){
    const specific = cfg.find(c => c.type===type && c.scope==='plate' && (c.plate||'').toLowerCase()===plate.toLowerCase());
    if (specific) return specific.months;
    const general = cfg.find(c => c.type===type && c.scope==='all');
    return general ? general.months : null;
  }

  buses.forEach(b=>{
    const maint = b.maintenance||[];

    const typesForBus = [
      ...new Set(
        cfg
          .filter(c => c.scope==='all' || (c.scope==='plate' && (c.plate||'').toLowerCase()===b.plate.toLowerCase()))
          .map(c => c.type)
      )
    ];

    typesForBus.forEach(type=>{
      const ovKey = keyFor(b.plate, type);
      let due = null;

      if (ovr[ovKey]) {
        due = new Date(ovr[ovKey]+'T00:00:00');
      } else {
        const months = monthsFor(b.plate, type);
        const last = lastByType(maint, type);
        if (months){
          if (last && last.date) {
            due = addMonths(new Date(last.date+'T00:00:00'), months);
          } else {
            due = null; // sin historial -> NO generar automáticamente
          }
        }
      }

      if (due){
        const days = daysUntil(due, now);
        const status = days < 0 ? 'Atrasado' : (wip.find(x=>x.key===ovKey) ? 'En Progreso' : 'Pendiente');
        tasks.push({
          key: ovKey,
          plate: b.plate, model: b.model, type,
          date: fmt(due), days, status,
          icon: iconByType(type)
        });
      }
    });
  });

  tasks.sort((a,b)=>{
    const ra = (a.status==='En Progreso'?0:(a.days<0?1:2));
    const rb = (b.status==='En Progreso'?0:(b.days<0?1:2));
    if (ra!==rb) return ra-rb;
    return (a.date||'').localeCompare(b.date||'');
  });

  return tasks;
}

/* ===== Render ===== */
const list = qs('#listContainer');
const fijosHeader = qs('#fijosHeader');

function iconByType(t){
  t=(t||'').toLowerCase();
  if (t.includes('freno')) return 'tire_repair';
  if (t.includes('neum')) return 'tire_repair';
  if (t.includes('aceite')) return 'oil_barrel';
  if (t.includes('revisión')) return 'engineering';
  if (t.includes('itv')) return 'build';
  return 'build';
}
function chip(status){
  const s=(status||'').toLowerCase();
  if (s==='en progreso') return `<span class="inline-flex items-center rounded-full bg-warning/20 px-2 py-1 text-xs font-medium text-warning">En Progreso</span>`;
  if (s==='atrasado')   return `<span class="inline-flex items-center rounded-full bg-danger/20 px-2 py-1 text-xs font-medium text-danger">Atrasado</span>`;
  if (s==='pendiente')  return `<span class="inline-flex items-center rounded-full bg-accent/20 px-2 py-1 text-xs font-medium text-accent">Pendiente</span>`;
  return `<span class="inline-flex items-center rounded-full bg-secondary/20 px-2 py-1 text-xs font-medium text-secondary">${status||'—'}</span>`;
}

function renderKPIs(){
  const buses = loadBuses();
  const upcoming = computeUpcoming();
  const wip = loadJson(LS_WIP, []);
  const totalMaint = allMaint(buses).length;
  qs('#kpiPendientes').textContent = upcoming.filter(x=>x.status==='Pendiente' && filterPass(x)).length;
  qs('#kpiProgreso').textContent   = wip.filter(x=> filterPass({plate:x.key.split('|')[0]})).length;
  qs('#kpiCompletados').textContent= totalMaint;
}

function filterPass(item){
  if (!searchText) return true;
  return (item.plate||'').toLowerCase().includes(searchText);
}

/* ---- Render pestañas ---- */
function renderProximos(){
  fijosHeader.classList.add('hidden');
  const upcoming = computeUpcoming().filter(filterPass);
  if (!upcoming.length){ list.innerHTML = emptyState('No hay próximos mantenimientos.'); return; }
  list.innerHTML = upcoming.map(it=>{
    const subtitle = it.days===0 ? 'Hoy'
      : (it.days<0 ? `Vencido hace ${Math.abs(it.days)} día(s)` : `Programado para ${it.date} (en ${it.days} día(s))`);
    return `
    <button class="w-full text-left card-prox flex items-center gap-4 bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700"
            data-key="${it.key}" data-type="${it.type}" data-plate="${it.plate}" data-date="${it.date}">
      <div class="flex items-center justify-center rounded-lg bg-primary/20 shrink-0 size-12">
        <span class="material-symbols-outlined text-primary">${it.icon}</span>
      </div>
      <div class="flex flex-col justify-center flex-1">
        <p class="text-gray-900 dark:text-white text-base font-bold leading-normal line-clamp-1">${it.type} - <span class="text-primary">${it.plate}</span></p>
        <p class="text-secondary text-sm font-normal leading-normal">${subtitle}</p>
      </div>
      <div class="flex flex-col items-end gap-2">
        ${chip(it.status)}
        <span class="material-symbols-outlined text-gray-400 dark:text-gray-500">chevron_right</span>
      </div>
    </button>`;
  }).join('');
  qsa('.card-prox').forEach(el=> el.addEventListener('click', ()=> openSheet(el.dataset)));
}

function renderFijos(){
  fijosHeader.classList.remove('hidden');
  const cfg = defaultCfgIfEmpty();
  if (!cfg.length){ list.innerHTML = emptyState('No hay mantenimientos recurrentes configurados.'); return; }
  list.innerHTML = cfg.map(c=>{
    const scope = c.scope==='all' ? 'Toda la flota' : `Sólo ${c.plate}`;
    return `
    <div class="flex flex-col gap-4 bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700">
      <div class="flex items-start justify-between">
        <div class="flex flex-col gap-1">
          <p class="text-gray-900 dark:text-white text-base font-bold leading-normal">${c.type}</p>
          <p class="text-secondary text-sm">Cada ${c.months} meses · ${scope}</p>
        </div>
        <div class="relative">
          <button class="text-gray-500 dark:text-gray-400 btn-more" data-id="${c.id}">
            <span class="material-symbols-outlined">more_vert</span>
          </button>
          <div class="menu hidden absolute right-0 mt-2 w-40 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow">
            <button class="w-full text-left px-3 py-2 text-sm hover:bg-gray-50 dark:hover:bg-gray-700 btn-edit" data-id="${c.id}">Editar</button>
            <button class="w-full text-left px-3 py-2 text-sm hover:bg-gray-50 dark:hover:bg-gray-700 text-danger btn-del" data-id="${c.id}">Eliminar</button>
          </div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <span class="material-symbols-outlined text-secondary">update</span>
        <p class="text-secondary text-sm font-medium">Próximo: <span class="text-gray-900 dark:text-white">según último historial / override</span></p>
      </div>
    </div>`;
  }).join('');

  qsa('.btn-more').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      e.stopPropagation();
      const menu = btn.parentElement.querySelector('.menu');
      qsa('.menu').forEach(m=> m.classList.add('hidden'));
      menu.classList.toggle('hidden');
      document.addEventListener('click', ()=> menu.classList.add('hidden'), {once:true});
    });
  });
  qsa('.btn-del').forEach(b=> b.addEventListener('click', ()=>{
    const id=b.dataset.id; const cfg=defaultCfgIfEmpty().filter(x=>x.id!==id); saveJson(LS_CFG,cfg); renderAll();
  }));
  qsa('.btn-edit').forEach(b=> b.addEventListener('click', ()=>{
    const id=b.dataset.id; const item = defaultCfgIfEmpty().find(x=>x.id===id);
    openCfgModal(item);
  }));
}

function renderHistorial(){
  fijosHeader.classList.add('hidden');
  const buses = loadBuses();
  let hist = allMaint(buses);
  hist.sort((a,b)=>(b.date||'').localeCompare(a.date||''));
  hist = hist.filter(m => !searchText || (m._plate||'').toLowerCase().includes(searchText));
  if (!hist.length){ list.innerHTML = emptyState('No hay historial de mantenimientos.'); return; }
  list.innerHTML = hist.slice(0,200).map(m=>{
    const when = m.date ? `Realizado el ${m.date}` : 'Sin fecha';
    const cost = (m.cost!=null) ? ` · Coste € ${(parseFloat(m.cost)||0).toFixed(2)}` : '';
    return `
    <a href="gestiondeFlota.html" class="flex items-center gap-4 bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700">
      <div class="flex items-center justify-center rounded-lg bg-primary/20 shrink-0 size-12"><span class="material-symbols-outlined text-primary">${iconByType(m.type)}</span></div>
      <div class="flex flex-col justify-center flex-1">
        <p class="text-gray-900 dark:text-white text-base font-bold leading-normal line-clamp-1">${m.type||'Mantenimiento'} - <span class="text-primary">${m._plate||''}</span></p>
        <p class="text-secondary text-sm">${when}${cost}</p>
      </div>
      <div class="flex flex-col items-end gap-2">
        <span class="inline-flex items-center rounded-full bg-success/20 px-2 py-1 text-xs font-medium text-success">Completado</span>
        <span class="material-symbols-outlined text-gray-400 dark:text-gray-500">chevron_right</span>
      </div>
    </a>`;
  }).join('');
}

function emptyState(text){
  return `<div class="p-4 rounded-xl bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
    <p class="text-sm text-secondary">${text}</p></div>`;
}

/* ===== Bottom sheet acciones ===== */
let currentItem = null; // {key,type,plate,date}

function openSheet(data){
  currentItem = {...data}; // string props
  qs('#sheetTitle').textContent = `${data.type} · ${data.plate}`;
  qs('#sheetSub').textContent = `Programado para ${data.date}`;
  qs('#sheet').classList.remove('hidden');
}
function closeSheet(){ qs('#sheet').classList.add('hidden'); currentItem=null; }

qs('#sheetMask').addEventListener('click', closeSheet);
qs('#actCancel').addEventListener('click', closeSheet);

qs('#actAccept').addEventListener('click', ()=>{
  if (!currentItem) return;
  const wip = loadJson(LS_WIP, []);
  if (!wip.find(x=>x.key===currentItem.key)){
    wip.push({key: currentItem.key, date: todayISO()});
    saveJson(LS_WIP, wip);
  }
  closeSheet(); renderAll();
});

/* ====== ARREGLO: guardar createdBy al completar ====== */
qs('#actDone').addEventListener('click', ()=>{
  if (!currentItem) return;
  const [plate, type] = [currentItem.plate, currentItem.type];

  // 1) Añadir entrada al historial del bus con createdBy = CURRENT_USER_ID
  const buses = loadBuses();
  const bus = buses.find(b => (b.plate||'').toLowerCase() === plate.toLowerCase());
  if (bus){
    bus.maintenance = bus.maintenance || [];
    bus.maintenance.push({
      id: 'mnt-' + (crypto.randomUUID ? crypto.randomUUID() : Date.now()),
      date: todayISO(),
      type,
      cost: 0,
      notes: 'Completado desde Gestión de Mantenimiento',
      createdBy: CURRENT_USER_ID
    });
    saveJson(LS_BUSES, buses);
  }

  // 2) Sacar de "en progreso"
  const wip = loadJson(LS_WIP, []).filter(x => x.key !== currentItem.key);
  saveJson(LS_WIP, wip);

  // 3) Eliminar override para recalcular próximo desde este "last"
  const ovr = loadJson(LS_OVR, {});
  delete ovr[currentItem.key];
  saveJson(LS_OVR, ovr);

  closeSheet(); renderAll();
});

qs('#actReprog').addEventListener('click', ()=>{
  if (!currentItem) return;
  const nd = prompt('Nueva fecha (YYYY-MM-DD):', currentItem.date || todayISO());
  if (!nd) return;
  if (!/^\d{4}-\d{2}-\d{2}$/.test(nd)){ alert('Formato inválido'); return; }
  const ovr = loadJson(LS_OVR, {});
  ovr[currentItem.key] = nd;
  saveJson(LS_OVR, ovr);
  closeSheet(); renderAll();
});

/* ===== Modal de Config recurrente ===== */
let editingCfgId = null;

function openCfgModal(item){
  editingCfgId = item?.id || null;
  qs('#modalCfgTitle').textContent = editingCfgId ? 'Editar recurrente' : 'Añadir recurrente';
  qs('#cfgType').value = item?.type || 'ITV';
  qs('#cfgMonths').value = item?.months ?? 6;
  const scope = item?.scope || 'all';
  qs('#cfgScope').value = scope;
  if (scope==='plate'){ qs('#cfgPlateWrap').classList.remove('hidden'); qs('#cfgPlate').value = item?.plate || ''; }
  else { qs('#cfgPlateWrap').classList.add('hidden'); qs('#cfgPlate').value=''; }
  qs('#modalCfg').classList.remove('hidden');
}
function closeCfgModal(){ qs('#modalCfg').classList.add('hidden'); editingCfgId=null; }

qs('#btnAddCfg').addEventListener('click', ()=> openCfgModal(null));
const btnCfgCancel = qs('#cfgCancel');
if (btnCfgCancel) btnCfgCancel.addEventListener('click', closeCfgModal);

const modalMask = qs('#modalMask');
if (modalMask) modalMask.addEventListener('click', closeCfgModal);

qs('#cfgScope').addEventListener('change', (e)=>{
  if (e.target.value==='plate') qs('#cfgPlateWrap').classList.remove('hidden');
  else qs('#cfgPlateWrap').classList.add('hidden');
});
qs('#cfgSave').addEventListener('click', ()=>{
  const type = qs('#cfgType').value;
  const months = Math.max(1, parseInt(qs('#cfgMonths').value||'1',10));
  const scope = qs('#cfgScope').value;
  const plate = scope==='plate' ? (qs('#cfgPlate').value||'').trim() : undefined;
  if (scope==='plate' && !plate){ alert('Indica la matrícula'); return; }

  let cfg = defaultCfgIfEmpty();
  if (editingCfgId){
    cfg = cfg.map(c => c.id===editingCfgId ? {...c, type, months, scope, plate} : c);
  } else {
    cfg.push({id: crypto.randomUUID?crypto.randomUUID():String(Date.now()), type, months, scope, plate});
  }
  saveJson(LS_CFG, cfg);
  closeCfgModal(); renderAll();
});

/* ===== Navegación tabs / back / search ===== */
function activateTab(tab){
  currentTab = tab;
  [['tabProximos','proximos'],['tabFijos','fijos'],['tabHistorial','historial']].forEach(([id,key])=>{
    const el=qs('#'+id);
    if (key===tab){ el.classList.add('border-b-primary','text-primary'); el.classList.remove('border-b-transparent','text-secondary'); }
    else { el.classList.add('border-b-transparent','text-secondary'); el.classList.remove('border-b-primary','text-primary'); }
  });
  renderBody();
}
function renderBody(){
  if (currentTab==='proximos') renderProximos();
  else if (currentTab==='fijos') renderFijos();
  else renderHistorial();
  renderKPIs();
}

qs('#btnBack').addEventListener('click', ()=> { window.location.href='dashboard.html'; });
qs('#tabProximos').addEventListener('click', ()=> activateTab('proximos'));
qs('#tabFijos').addEventListener('click', ()=> activateTab('fijos'));
qs('#tabHistorial').addEventListener('click', ()=> activateTab('historial'));

qs('#inpSearch').addEventListener('input', e=>{ searchText=(e.target.value||'').toLowerCase().trim(); renderBody(); });

/* ===== Init & auto-refresh ===== */
function renderAll(){ renderBody(); }
window.addEventListener('DOMContentLoaded', ()=>{
  activateTab('proximos');
});
window.addEventListener('storage', (e)=> {
  if ([LS_BUSES,LS_CFG,LS_OVR,LS_WIP].includes(e.key)) renderAll();
});
</script>
</body>
</html>
<script src="app-ui.js"></script>
